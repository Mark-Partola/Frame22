{% if request == false %}
	{% include 'default/admin/header.html' %}
	<section id="main" class="column">
{% endif %}


<h4 class="alert_info">Страница управления пользователями</h4>

<article class="module width_full">
	<header><h3>Зарегистрированные пользователи</h3></header>

	<div class="tab_container">
		<div id="j-users-container">
		<table class="tablesorter" cellspacing="0" id="j-users-table">
			<thead>
				<tr>
					<th></th>
					<th>Имя</th>
					<th>Фамилия</th>
					<th>Отчество</th>
					<th>Логин</th>
					<th>Адрес</th>
					<th>Дата рождения</th>
					<th>Телефон</th>
					<th>Email</th>
					<th>Активность</th>
					<th>Роль</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{% for user in users %}
					<tr>
						<td><input type="checkbox" value="{{user.id}}"></td>
						<td>{{user.fname}}</td>
						<td>{{user.lname}}</td>

						{% if user.patronymic %}
							<td>{{user.patronymic}}</td>
						{% else %}
							<td>Нет данных</td>
						{% endif %}

						<td>{{user.login}}</td>

						{% if user.address %}
							<td>{{user.address}}</td>
						{% else %}
							<td>Нет данных</td>
						{% endif %}

						{% if user.birthday %}
							<td>{{user.birthday}}</td>
						{% else %}
							<td>Нет данных</td>
						{% endif %}

						{% if user.phone %}
							<td>{{user.phone}}</td>
						{% else %}
							<td>Нет данных</td>
						{% endif %}

						<td>{{user.email}}</td>

						{% if user.status == 1 %}
							<td><input type="checkbox" checked="checked" name="{{login}}" value="{{user.status}}"></td>
						{% else %}
							<td><input type="checkbox" name="{{login}}" value="{{user.status}}"></td>
						{% endif %}

						<td>{{user.user_role}}</td>

						<td>
							<input type="image" src="{{dir}}/imgs/admin/icn_edit.png" title="Изменить">
							<input type="image" src="{{dir}}/imgs/admin/icn_trash.png" title="Удалить">
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
		</div>
		<footer>
			<h3 style="font-size:20px; text-transform: lowercase; margin-top: 3px;">
			{% if countUsers != 1 %}
				<a href="#" style="margin-right: 10px;" class="j-usersNav-link" data-dir="left">
					<i class="fa fa-angle-left"></i> Туда
				</a>

				{% for i in 1..countUsers %}

						<a href="#" data-pos="{{i}}" class="j-pagination">{{ i }}</a>

				{% endfor %}

				<a href="#" style="margin-left: 10px;" class="j-usersNav-link" data-dir="right">Сюда 
					<i class="fa fa-angle-right"></i>
				</a>
			{% endif %}
			</h3>
		</footer>
	</div>
</article>
<article class="module width_quarter">
	<header><h3>Новый пользователь</h3></header>

	<div class="module_content">
		<fieldset class="j-register">
			<div class="module_content-field">
				<label>Имя<span>*</span></label>
				<input type="text" name="fname" placeholder="Имя">
			</div>
			<div class="module_content-field">
				<label>Фамилия<span>*</span></label>
				<input type="text" name="lname" placeholder="Фамилия">
			</div>
			<div class="module_content-field">
				<label>Логин<span>*</span></label>
				<input type="text" name="login" placeholder="Логин">
			</div>
			<div class="module_content-field">
				<label>Пароль<span>*</span></label>
				<input type="text" name="pass" placeholder="Пароль">
			</div>
			<div class="module_content-field">
				<label>E-mail<span>*</span></label>
				<input type="text" name="email" placeholder="Электронная почта">
			</div>
			<div class="module_content-field">
				<label>Роль в системе<span>*</span></label>
				<div class="select-wrapper">
					<select name="role" id="" class="module_content-select">
						{% for role in roles %}
							<option value="{{role.privileges}}">{{role.title}}</option>
						{% endfor %}
					</select>
				</div>
			</div>
			<div class="module_content-field">
				<input type="button" value="Создать" class="button" id="j-create-user">
			</div>
		</fieldset>
	</div>
</article>
<article class="module width_3_quarter">
	<header><h3>Создание новой роли</h3></header>

	<div class="module_content">
		<fieldset class="j-register">
			<div class="module_content-field">
				<label>Название роли<span>*</span></label>
				<input id="j-title-action" type="text" name="title" placeholder="Название роли">
			</div>
			<div class="module_content-field">
				<label>Разрешенные действия</label>
				<div class="wrapper-chechbox" style="border-bottom: 1px dashed #999; width: 85%; margin-bottom: 20px;">
					<label id="j-check-all-actions" class="title-role label-button" style="color:#47CE5A">Отметить все</label>
					<label id="j-uncheck-all-actions" class="title-role label-button" style="color:#CE5A47">Сбросить все</label>
				</div>
				<div class="wrapper-chechbox">
					{% for action in actions %}
						<label class="title-role">{{action.title}}<input name="action" value="{{action.id}}" type="checkbox" class="j-action"></label>
					{% endfor %}
				</div>
			</div>
			<div class="module_content-field">
				<input type="button" value="Создать" class="button" id="j-create-role">
			</div>
		</fieldset>
	</div>
</article>

<script>

	(function(){
		$('#j-check-all-actions').on('click', function(){
			$('.j-action').prop('checked', true);
		});
		$('#j-uncheck-all-actions').on('click', function(){
			$('.j-action').prop('checked', false);
		});
		$('#j-create-role').on('click', function(){
			var actions = {};
			actions.ids = [];
			$('[name=action]:checked').each(function(){
				actions.ids.push($(this).val());
			});
			var title = $('#j-title-action').val();
			actions.title = title;
			var jsonActions = JSON.stringify(actions);
			console.log(jsonActions);
		});
	})();

	(function(){
		$('#j-create-user').on('click', function(){
			var workArea = $('.j-register');
			var formData = {};
			formData.fname = workArea.find('[name=fname]').val();
			formData.lname = workArea.find('[name=lname]').val();
			formData.login = workArea.find('[name=login]').val();
			formData.pass  = workArea.find('[name=pass]').val();
			formData.email = workArea.find('[name=email]').val();
			formData.role  = workArea.find('[name=role]').val();
			console.log(JSON.stringify(formData));
			$.ajax({
				type: "POST",
				data: JSON.stringify(formData),
				url: $('.j-dir').html() + '/admin/users/create',
				success: function(data){
					data = JSON.parse(data);

					var bgc = '#CE5A47';
					if(data.status){
						var bgc = '#47CE5A';
					}
					$('.message-box').html(data.title);
					$('.message-box').css({
						'display': 'block',
						'background-color': bgc
					}, 1000);
				}
			});
		});
	})();

	/*
	* Навигация по пользователям
	*/
	var pageUser = 1; //текущая страница
	var hidden; //скрытая кнопка
	var itemHeight = $('#j-users-container th').css('height');
	var tableHeight = parseInt(itemHeight) * $('#j-users-container tr').length + 50;
	$('#j-users-container').css('min-height', tableHeight +'px');

	hideDirectionButton(); //сразу активируем, т.к первая страница, нужно скрыть кнопку влево

	function hideDirectionButton(count){

		var direction;

		//определяем границу
		if(pageUser === 1){
			direction = 'left'
		}else if(pageUser === count){
			direction = 'right'
		}

		//управляем показать/скрыть в зависимости от границы
		if(hidden)
			hidden.css({
				'opacity': 1,
				'pointer-events': 'auto'
			});

		var what = $('.j-usersNav-link[data-dir='+direction+']');
		what.css({
			'opacity': 0,
			'pointer-events': 'none'
		});

		hidden = what;

		//подсветка активного пункта
		var buttonPagination = $('.j-pagination');
		buttonPagination.css({
			'color': '#77BACE',
			'pointer-events': 'auto'
		});
		buttonPagination.eq(pageUser-1).css({
			'color': '#999',
			'pointer-events': 'none'
		});
	}

	$('.j-usersNav-link').on('click', function(e){
		var direction = $(this).data('dir');
		if(direction === 'right'){
			if(pageUser < {{countUsers}})
				pageUser++;
		} else {
			if(pageUser > 1)
				pageUser--;
		}

		hideDirectionButton({{countUsers}});

		console.log(pageUser);

		e.preventDefault();
		$('body').trigger('getUsersByOffset', pageUser);

	});

	$('.j-pagination').on('click', function(e){

		pageUser = $(this).data('pos');

		hideDirectionButton({{countUsers}});

		e.preventDefault();
		$('body').trigger('getUsersByOffset', pageUser);
	});


	//запрос с сервера пользователей по смещению
	$('body').on('getUsersByOffset', function(e, offset){
		var offsetUser = offset;
		$.ajax({
			'url' : $('.j-dir').html()+'/admin/users?usersOffset='+offsetUser,
			success: function(data){
				var fragment = $('<div>').html(data);
				$('#j-users-container').css('opacity', 0);
				$('#j-users-container').html($('#j-users-table', fragment));
				$('#j-users-container').animate({'opacity': 1}, 500);
				$('body').trigger('ajax');
			}
		});
	});

</script>

<script>
	$('body').trigger('ajax');
</script>


{% if request == false %}
	</section>
{% endif %}

